# Использование из другого репо:
#   jobs:
#     run-pipeline:
#       uses: AralAskarov/github-actions-executor/.github/workflows/executor.yml@main
#       with:
#         pipeline_config_sources: "https://github.com/org/repo/blob/main/pipeline.yaml"
#         pipeline_vars: "KEY1=val1; KEY2=val2"
#       secrets:
#         access_token: ${{ secrets.GH_PAT }}

name: Loom Pipeline Executor

on:
  workflow_call:
    inputs:
      pipeline_config_sources:
        description: "YAML links to pipeline definitions, comma/space separated"
        required: true
        type: string
      pipeline_vars:
        description: "Extra variables: KEY1=val1; KEY2=val2"
        required: false
        type: string
        default: ""
      executor_image:
        description: "Executor Docker image"
        required: false
        type: string
        default: "arala/github_actions_executor:7"
    secrets:
      access_token:
        description: "GitHub token for accessing files in external repos"
        required: false

  workflow_dispatch:
    inputs:
      pipeline_config_sources:
        description: "YAML links to pipeline definitions, comma/space separated"
        required: true
        type: string
      pipeline_vars:
        description: "Extra variables: KEY1=val1; KEY2=val2"
        required: false
        type: string
      executor_image:
        description: "Executor Docker image"
        required: false
        type: string
        default: "arala/github_actions_executor:5"

jobs:
  generate:
    name: Generate Pipeline
    runs-on: ubuntu-latest
    container:
      image: ${{ inputs.executor_image }}
    outputs:
      matrix: ${{ steps.gen.outputs.matrix }}
    steps:
      - uses: actions/checkout@v4

      - name: Generate workflow and matrix
        id: gen
        run: |
          VARS_FLAG=""
          if [ -n "${{ inputs.pipeline_vars }}" ]; then
            VARS_FLAG="--pipeline-vars \"${{ inputs.pipeline_vars }}\""
          fi

          echo "=== Generating workflow ==="
          eval github-actions-executor run \
            --sources "${{ inputs.pipeline_config_sources }}" \
            --token "${{ secrets.access_token }}" \
            $VARS_FLAG \
            -o generated-workflow.yml
          echo "--- Generated workflow ---"
          cat generated-workflow.yml
          echo ""
          echo "=== Generating matrix ==="
          MATRIX=$(eval github-actions-executor generate-matrix \
            --sources "${{ inputs.pipeline_config_sources }}" \
            --token "${{ secrets.access_token }}" \
            $VARS_FLAG)
          echo "matrix=$MATRIX" >> $GITHUB_OUTPUT
          echo "$MATRIX" | python3 -m json.tool

      - name: Upload generated workflow
        uses: actions/upload-artifact@v4
        with:
          name: generated-workflow
          path: generated-workflow.yml
          retention-days: 1

  execute:
    name: "Execute: ${{ matrix.job_name }}"
    needs: generate
    runs-on: ubuntu-latest
    container:
      image: ${{ matrix.image }}
    strategy:
      matrix: ${{ fromJson(needs.generate.outputs.matrix) }}
      fail-fast: false
    steps:
      - uses: actions/checkout@v4

      - name: "${{ matrix.command }}"
        run: ${{ matrix.command }}
