# Использование из другого репо:
#   jobs:
#     run-pipeline:
#       uses: AralAskarov/github-actions-executor/.github/workflows/executor.yml@main
#       with:
#         pipeline_config_sources: "https://github.com/org/repo/blob/main/pipeline.yaml"
#         pipeline_vars: "KEY1=val1; KEY2=val2"
#       secrets:
#         access_token: ${{ secrets.GH_PAT }}

name: Loom Pipeline Executor

on:
  workflow_call:
    inputs:
      pipeline_config_sources:
        description: "YAML links to pipeline definitions, comma/space separated"
        required: true
        type: string
      pipeline_vars:
        description: "Extra variables: KEY1=val1; KEY2=val2"
        required: false
        type: string
        default: ""
      executor_image:
        description: "Executor Docker image"
        required: false
        type: string
        default: "arala/github_actions_executor:12"
    secrets:
      access_token:
        description: "GitHub token for accessing files in external repos"
        required: false

  workflow_dispatch:
    inputs:
      pipeline_config_sources:
        description: "YAML links to pipeline definitions, comma/space separated"
        required: true
        type: string
      pipeline_vars:
        description: "Extra variables: KEY1=val1; KEY2=val2"
        required: false
        type: string
      executor_image:
        description: "Executor Docker image"
        required: false
        type: string
        default: "arala/github_actions_executor:10"

jobs:
  generate:
    name: Generate Pipeline
    runs-on: ubuntu-latest
    container:
      image: ${{ inputs.executor_image }}
    outputs:
      matrix: ${{ steps.gen.outputs.matrix }}
    steps:
      - uses: actions/checkout@v4

      - name: Generate workflow and matrix
        id: gen
        run: |
          echo "=== Generating workflow ==="
          github-actions-executor run \
            --sources "${{ inputs.pipeline_config_sources }}" \
            --token "${{ secrets.access_token }}" \
            --pipeline-vars "${{ inputs.pipeline_vars }}" \
            -o generated-workflow.yml
          echo "--- Generated workflow ---"
          cat generated-workflow.yml
          echo ""
          echo "=== Generating matrix ==="
          MATRIX=$(github-actions-executor generate-matrix \
            --sources "${{ inputs.pipeline_config_sources }}" \
            --token "${{ secrets.access_token }}" \
            --pipeline-vars "${{ inputs.pipeline_vars }}")
          echo "matrix=$MATRIX" >> $GITHUB_OUTPUT
          echo "$MATRIX" | python3 -m json.tool

      - name: Upload generated workflow
        uses: actions/upload-artifact@v4
        with:
          name: generated-workflow
          path: generated-workflow.yml
          retention-days: 1

  execute:
    name: "Execute: ${{ matrix.job_name }}"
    needs: generate
    runs-on: ubuntu-latest
    strategy:
      matrix: ${{ fromJson(needs.generate.outputs.matrix) }}
      fail-fast: false
    steps:
      - uses: actions/checkout@v4

      - name: Parse environment variables
        run: |
          echo '${{ matrix.env_json }}' | python3 -c "
          import sys, json, os
          SKIP = {'DOCKER_HOST', 'DOCKER_TLS_CERTDIR'}
          env = json.load(sys.stdin)
          gh_env = os.environ.get('GITHUB_ENV', '')
          if gh_env:
              with open(gh_env, 'a') as f:
                  for k, v in env.items():
                      if k not in SKIP:
                          f.write(f'{k}={v}\n')
          "

      - name: "${{ matrix.job_name }}"
        run: |
          # Build docker run env flags, filtering out dind-specific vars
          ENV_FLAGS=$(echo '${{ matrix.env_json }}' | python3 -c "
          import sys, json
          SKIP = {'DOCKER_HOST', 'DOCKER_TLS_CERTDIR'}
          env = json.load(sys.stdin)
          for k, v in env.items():
              if k not in SKIP:
                  print(f'-e {k}={v}')
          " | tr '\n' ' ')

          docker run --rm \
            -v /var/run/docker.sock:/var/run/docker.sock \
            -v "${{ github.workspace }}:/workspace" \
            -w /workspace \
            $ENV_FLAGS \
            ${{ matrix.image }} \
            sh -c "${{ matrix.command }}"
